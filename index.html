<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.png" type="image/x-icon">
    <title>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Å—Ç–∞–∫–∞–Ω –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞. <a href="manual.html" target="_blank">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</a></title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #0f1923;
            color: #e8e8e8;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #26313d;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #61dafb;
            font-size: 24px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .coins-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #1a2431;
            border-radius: 6px;
        }
        
        .coin-item {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border: 1px solid #344658;
            background-color: #1e2a38;
            position: relative;
        }
        
        .coin-item:hover {
            background-color: #2d3e50;
            transform: translateY(-2px);
        }
        
        .coin-item.selected {
            background-color: #2962ff;
            border-color: #2962ff;
        }
        
        .coin-item.rising {
            background: linear-gradient(135deg, #2d4a2c 0%, #1e3e1e 100%);
            border-color: #4caf50;
        }
        
        .coin-item.falling {
            background: linear-gradient(135deg, #4a2c2c 0%, #3e1e1e 100%);
            border-color: #f44336;
        }
        
        .coin-name {
            font-weight: bold;
            font-size: 12px;
        }
        
        .coin-price {
            font-size: 11px;
            color: #8c98a8;
        }
        
        .coin-change {
            font-size: 11px;
            font-weight: bold;
        }
        
        .change-up {
            color: #4caf50;
        }
        
        .change-down {
            color: #f44336;
        }
        
        .exchange-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .exchange-btn {
            background-color: #2d3e50;
            border: 1px solid #344658;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .exchange-btn.active {
            background-color: #2962ff;
            border-color: #2962ff;
        }
        
        .exchange-btn:hover:not(.active) {
            background-color: #3a506b;
        }
        
        .mexc-trade-btn {
            background-color: #4caf50;
            border: 1px solid #43a047;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            color: white;
            font-size: 14px;
        }
        
        .mexc-trade-btn:hover {
            background-color: #43a047;
            transform: translateY(-1px);
        }
        
        input, select, button {
            background-color: #1e2a38;
            color: #e8e8e8;
            border: 1px solid #344658;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        
        input:focus, select:focus {
            border-color: #61dafb;
        }
        
        button {
            background-color: #2962ff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #1a56e8;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-connected {
            background-color: #4caf50;
        }
        
        .status-error {
            background-color: #f44336;
        }
        
        .status-connecting {
            background-color: #ff9800;
        }
        
        .status-disconnected {
            background-color: #9e9e9e;
        }
        
        .orderbook {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .orderbook-section {
            flex: 1;
            min-width: 300px;
            background-color: #1a2431;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .orderbook-header {
            background-color: #26313d;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        
        .orderbook-content {
            height: 400px;
            overflow-y: auto;
        }
        
        .order-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 15px;
            font-family: monospace;
            position: relative;
            overflow: hidden;
        }
        
        .order-row.bid:hover, .order-row.ask:hover {
            background-color: #26313d;
        }
        
        .bid .size-bar {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(76, 175, 80, 0.2);
            z-index: 0;
        }
        
        .ask .size-bar {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            background-color: rgba(244, 67, 54, 0.2);
            z-index: 0;
        }
        
        .price {
            z-index: 1;
        }
        
        .size {
            z-index: 1;
        }
        
        .bid .price {
            color: #4caf50;
        }
        
        .ask .price {
            color: #f44336;
        }
        
        .support-level {
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 3px solid #4caf50;
        }
        
        .resistance-level {
            background-color: rgba(244, 67, 54, 0.1);
            border-left: 3px solid #f44336;
        }
        
        .level-label {
            position: absolute;
            left: 5px;
            font-size: 9px;
            color: #8c98a8;
        }
        
        .spread {
            text-align: center;
            padding: 10px;
            background-color: #26313d;
            margin-bottom: 20px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: #1a2431;
            padding: 15px;
            border-radius: 6px;
            position: relative;
        }
        
        .stat-title {
            font-size: 12px;
            color: #8c98a8;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .alert-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4caf50;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .alert-indicator.active {
            opacity: 1;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .depth-chart {
            height: 200px;
            background-color: #1a2431;
            border-radius: 6px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .depth-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.3;
        }
        
        .bid-depth {
            background: linear-gradient(to right, rgba(76, 175, 80, 0.5), transparent);
        }
        
        .ask-depth {
            background: linear-gradient(to left, rgba(244, 67, 54, 0.5), transparent);
        }
        
        .last-price {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2962ff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .error-message {
            background-color: #4a2c2c;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
        }
        
        .alert-message {
            background-color: #2c4a2c;
            color: #4caf50;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
            display: none;
        }
        
        .alert-message.warning {
            background-color: #4a3c2c;
            color: #ff9800;
            border-left: 4px solid #ff9800;
        }
        
        .alert-message.danger {
            background-color: #4a2c2c;
            color: #f44336;
            border-left: 4px solid #f44336;
        }
        
        .alert-message.visible {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .retry-button {
            background-color: #f44336;
            margin-top: 10px;
        }
        
        .retry-button:hover {
            background-color: #e53935;
        }
        
        .connection-info {
            background-color: #1a2431;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
            color: #8c98a8;
        }
        
        .cluster-info {
            background-color: #1a2431;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .cluster-bar {
            height: 10px;
            background: linear-gradient(90deg, #4caf50 0%, #ff9800 50%, #f44336 100%);
            border-radius: 5px;
            margin: 5px 0;
            position: relative;
        }
        
        .cluster-marker {
            position: absolute;
            top: -2px;
            width: 2px;
            height: 14px;
            background-color: white;
        }
        
        .advice-container {
            background-color: #1a2431;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .advice-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #61dafb;
        }
        
        .advice-content {
            font-size: 14px;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .orderbook {
                flex-direction: column;
            }
            
            .orderbook-section {
                width: 100%;
            }
            
            .exchange-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .exchange-btn {
                width: 100%;
                text-align: center;
            }
            
            .coins-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .mexc-trade-btn {
                width: 100%;
                text-align: center;
                margin-top: 10px;
            }
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #8c98a8;
        }
        
        .ws-status {
            font-size: 12px;
            color: #8c98a8;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Å—Ç–∞–∫–∞–Ω –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞</h1>
            <div class="status">
                <div class="status-indicator status-disconnected" id="statusIndicator"></div>
                <span id="statusText">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏—Ä–∂—É –∏ –º–æ–Ω–µ—Ç—É</span>
                <span class="ws-status" id="wsStatus"></span>
            </div>
        </header>
        
        <div class="controls">
            <div class="coins-grid" id="coinsGrid">
                <!-- –ú–æ–Ω–µ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            
            <div class="exchange-buttons">
                <button class="exchange-btn" data-exchange="binance">Binance</button>
                <button class="exchange-btn" data-exchange="bybit">Bybit</button>
                <button class="exchange-btn" data-exchange="mexc">MEXC</button>
                <button class="exchange-btn" data-exchange="kucoin">KuCoin</button>
                <button class="exchange-btn" data-exchange="gateio">Gate.io</button>
                <button class="exchange-btn" data-exchange="okx">OKX</button>
                <button class="exchange-btn" data-exchange="htx">HTX</button>
            </div>
            
            <input type="text" id="symbolInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä—É (BTCUSDT)" value="">
            <select id="timeframeSelect">
                <option value="1000">1 —Å–µ–∫—É–Ω–¥–∞</option>
                <option value="2000">2 —Å–µ–∫—É–Ω–¥—ã</option>
                <option value="5000">5 —Å–µ–∫—É–Ω–¥</option>
                <option value="10000" selected>10 —Å–µ–∫—É–Ω–¥</option>
            </select>
            <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <a href="#" id="mexcTradeBtn" class="mexc-trade-btn" target="_blank" style="display: none;">
                üìä –¢–æ—Ä–≥–æ–≤–∞—Ç—å –Ω–∞ MEXC
            </a>
        </div>
        
        <div class="connection-info">
            üí° –î–ª—è —Ä–∞–∑–Ω—ã—Ö –±–∏—Ä–∂ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ñ–æ—Ä–º–∞—Ç: Binance: BTCUSDT, MEXC: BTCUSDT, KuCoin: BTC-USDT, Gate.io: BTC_USDT
        </div>
        
        <div id="errorContainer"></div>
        
        <div class="alert-message" id="trendAlert">
            <strong>üìà –í–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥:</strong> –û–±—ä–µ–º –ø–æ–∫—É–ø–æ–∫ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ <span id="trendStrength">0</span>%
            <div class="advice-content" id="trendAdvice"></div>
        </div>
        
        <div class="alert-message warning" id="warningAlert" style="display: none;">
            <strong>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> <span id="warningText"></span>
            <div class="advice-content" id="warningAdvice"></div>
        </div>
        
        <div class="alert-message danger" id="dangerAlert" style="display: none;">
            <strong>üî¥ –û–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> <span id="dangerText"></span>
            <div class="advice-content" id="dangerAdvice"></div>
        </div>
        
        <div class="spread" id="spreadElement">
            –°–ø—Ä–µ–¥: –í—ã–±–µ—Ä–∏—Ç–µ –±–∏—Ä–∂—É –∏ –º–æ–Ω–µ—Ç—É
        </div>
        
        <div class="orderbook">
            <div class="orderbook-section">
                <div class="orderbook-header">
                    <span>–ü–æ–∫—É–ø–∫–∞ (Bid)</span>
                    <span>–û–±—ä–µ–º</span>
                </div>
                <div class="orderbook-content" id="bidsContainer">
                    <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏—Ä–∂—É –∏ –º–æ–Ω–µ—Ç—É</div>
                </div>
            </div>
            
            <div class="orderbook-section">
                <div class="orderbook-header">
                    <span>–ü—Ä–æ–¥–∞–∂–∞ (Ask)</span>
                    <span>–û–±—ä–µ–º</span>
                </div>
                <div class="orderbook-content" id="asksContainer">
                    <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏—Ä–∂—É –∏ –º–æ–Ω–µ—Ç—É</div>
                </div>
            </div>
        </div>
        
        <div class="depth-chart" id="depthChart">
            <div class="depth-area bid-depth" id="bidDepth"></div>
            <div class="depth-area ask-depth" id="askDepth"></div>
            <div class="last-price" id="lastPrice">0</div>
        </div>
        
        <div class="cluster-info">
            <div class="stat-title">–ö–ª–∞—Å—Ç–µ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏</div>
            <div class="cluster-bar" id="clusterBar">
                <div class="cluster-marker" id="clusterMarker" style="left: 50%;"></div>
            </div>
            <div id="clusterText">–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-title">–û–±—â–∏–π –æ–±—ä–µ–º –ø–æ–∫—É–ø–æ–∫</div>
                <div class="stat-value" id="totalBidVolume">0</div>
                <div class="alert-indicator" id="bidAlert"></div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–û–±—â–∏–π –æ–±—ä–µ–º –ø—Ä–æ–¥–∞–∂</div>
                <div class="stat-value" id="totalAskVolume">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–î–∏—Å–±–∞–ª–∞–Ω—Å —Å—Ç–∞–∫–∞–Ω–∞</div>
                <div class="stat-value" id="orderbookImbalance">0%</div>
                <div class="alert-indicator" id="imbalanceAlert"></div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–ú–∞–∫—Å. –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏</div>
                <div class="stat-value" id="maxBidDensity">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–ú–∞–∫—Å. –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∏</div>
                <div class="stat-value" id="maxAskDensity">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –æ–±—ä–µ–º–æ–≤</div>
                <div class="stat-value" id="volumeRatio">1:1</div>
                <div class="alert-indicator" id="ratioAlert"></div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω</div>
                <div class="stat-value" id="priceChange">0%</div>
            </div>
        </div>
        
        <div class="advice-container">
            <div class="advice-title">üìã –¢–æ—Ä–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
            <div class="advice-content" id="tradingAdvice">
                –í—ã–±–µ—Ä–∏—Ç–µ –±–∏—Ä–∂—É –∏ –º–æ–Ω–µ—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
            </div>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentSymbol = '';
        let currentTimeframe = 10000;
        let currentExchange = null;
        let orderbook = { bids: {}, asks: {} };
        let isConnected = false;
        let updateInterval = null;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        let alertTimeout = null;
        let coinPrices = {};
        let priceHistory = [];
        let ws = null;
        let useWebSocket = true;
        let supportLevels = [];
        let resistanceLevels = [];
        let lastProcessedData = null;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const wsStatus = document.getElementById('wsStatus');
        const coinsGrid = document.getElementById('coinsGrid');
        const symbolInput = document.getElementById('symbolInput');
        const timeframeSelect = document.getElementById('timeframeSelect');
        const connectBtn = document.getElementById('connectBtn');
        const mexcTradeBtn = document.getElementById('mexcTradeBtn');
        const errorContainer = document.getElementById('errorContainer');
        const trendAlert = document.getElementById('trendAlert');
        const warningAlert = document.getElementById('warningAlert');
        const dangerAlert = document.getElementById('dangerAlert');
        const trendStrength = document.getElementById('trendStrength');
        const warningText = document.getElementById('warningText');
        const dangerText = document.getElementById('dangerText');
        const trendAdvice = document.getElementById('trendAdvice');
        const warningAdvice = document.getElementById('warningAdvice');
        const dangerAdvice = document.getElementById('dangerAdvice');
        const spreadElement = document.getElementById('spreadElement');
        const bidsContainer = document.getElementById('bidsContainer');
        const asksContainer = document.getElementById('asksContainer');
        const bidDepth = document.getElementById('bidDepth');
        const askDepth = document.getElementById('askDepth');
        const lastPrice = document.getElementById('lastPrice');
        const totalBidVolume = document.getElementById('totalBidVolume');
        const totalAskVolume = document.getElementById('totalAskVolume');
        const orderbookImbalance = document.getElementById('orderbookImbalance');
        const maxBidDensity = document.getElementById('maxBidDensity');
        const maxAskDensity = document.getElementById('maxAskDensity');
        const volumeRatio = document.getElementById('volumeRatio');
        const priceChange = document.getElementById('priceChange');
        const bidAlert = document.getElementById('bidAlert');
        const imbalanceAlert = document.getElementById('imbalanceAlert');
        const ratioAlert = document.getElementById('ratioAlert');
        const tradingAdvice = document.getElementById('tradingAdvice');
        const clusterBar = document.getElementById('clusterBar');
        const clusterMarker = document.getElementById('clusterMarker');
        const clusterText = document.getElementById('clusterText');
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–æ–Ω–µ—Ç —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–∞ –±–∏—Ä–∂–∞—Ö
        const popularCoins = [
            { symbol: 'BTCUSDT', name: 'BTC', price: 61452, change: 2.5, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'ETHUSDT', name: 'ETH', price: 3410, change: 1.8, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'BNBUSDT', name: 'BNB', price: 586, change: 3.2, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'SOLUSDT', name: 'SOL', price: 142, change: 5.7, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'XRPUSDT', name: 'XRP', price: 0.487, change: 2.1, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'DOGEUSDT', name: 'DOGE', price: 0.123, change: 8.5, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'TONUSDT', name: 'TON', price: 7.35, change: 4.3, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'ADAUSDT', name: 'ADA', price: 0.432, change: 1.9, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'AVAXUSDT', name: 'AVAX', price: 27.8, change: 6.2, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'SHIBUSDT', name: 'SHIB', price: 0.0000215, change: 12.7, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'DOTUSDT', name: 'DOT', price: 6.23, change: 3.4, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'LINKUSDT', name: 'LINK', price: 13.47, change: 2.8, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'MATICUSDT', name: 'MATIC', price: 0.567, change: 1.5, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'TRXUSDT', name: 'TRX', price: 0.117, change: 0.9, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'BCHUSDT', name: 'BCH', price: 385, change: 2.3, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'LTCUSDT', name: 'LTC', price: 74.3, change: 1.7, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'UNIUSDT', name: 'UNI', price: 9.12, change: 4.1, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'ATOMUSDT', name: 'ATOM', price: 7.85, change: 2.6, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'XLMUSDT', name: 'XLM', price: 0.105, change: 1.2, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'XMRUSDT', name: 'XMR', price: 168, change: 0.8, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx'] },
            { symbol: 'ETCUSDT', name: 'ETC', price: 26.4, change: 1.4, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'FILUSDT', name: 'FIL', price: 5.67, change: 3.9, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'APTUSDT', name: 'APT', price: 8.32, change: 7.3, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx'] },
            { symbol: 'ARBUSDT', name: 'ARB', price: 0.945, change: 5.6, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx'] },
            { symbol: 'NEARUSDT', name: 'NEAR', price: 5.21, change: 6.8, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'VETUSDT', name: 'VET', price: 0.0312, change: 2.5, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'RUNEUSDT', name: 'RUNE', price: 4.35, change: 8.2, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx'] },
            { symbol: 'AAVEUSDT', name: 'AAVE', price: 102.3, change: 4.7, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx'] },
            { symbol: 'ALGOUSDT', name: 'ALGO', price: 0.162, change: 3.1, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx', 'htx'] },
            { symbol: 'QNTUSDT', name: 'QNT', price: 86.5, change: 2.2, available: ['binance', 'bybit', 'mexc', 'kucoin', 'gateio', 'okx'] }
        ];
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–Ω–µ—Ç—ã –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –∏–∑–º–µ–Ω–µ–Ω–∏—è
        popularCoins.sort((a, b) => b.change - a.change);
        
        // API endpoints –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±–∏—Ä–∂ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
        const exchangeAPIs = {
            binance: {
                rest: {
                    depth: (symbol) => `https://api.binance.com/api/v3/depth?symbol=${symbol}&limit=1000`,
                    exchangeInfo: `https://api.binance.com/api/v3/exchangeInfo`
                },
                ws: {
                    depth: (symbol) => `wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@depth20@1000ms`
                },
                name: 'Binance',
                format: 'BTCUSDT',
                formatExample: 'BTCUSDT'
            },
            bybit: {
                rest: {
                    depth: (symbol) => `https://api.bybit.com/v5/market/orderbook?category=spot&symbol=${symbol}&limit=1000`
                },
                ws: {
                    depth: (symbol) => `wss://stream.bybit.com/v5/public/spot`
                },
                name: 'Bybit',
                format: 'BTCUSDT',
                formatExample: 'BTCUSDT'
            },
            mexc: {
                rest: {
                    depth: (symbol) => `https://api.mexc.com/api/v3/depth?symbol=${symbol}&limit=1000`
                },
                name: 'MEXC',
                format: 'BTCUSDT',
                formatExample: 'BTCUSDT',
                tradeUrl: (symbol) => `https://www.mexc.com/ru-RU/exchange/${symbol.replace('USDT', '_USDT')}`
            },
            kucoin: {
                rest: {
                    depth: (symbol) => `https://api.kucoin.com/api/v1/market/orderbook/level2_100?symbol=${symbol.replace('USDT', '-USDT')}`
                },
                name: 'KuCoin',
                format: 'BTC-USDT',
                formatExample: 'BTC-USDT'
            },
            gateio: {
                rest: {
                    depth: (symbol) => `https://api.gateio.ws/api/v4/spot/order_book?currency_pair=${symbol.replace('USDT', '_USDT')}&limit=1000`
                },
                name: 'Gate.io',
                format: 'BTC_USDT',
                formatExample: 'BTC_USDT'
            },
            okx: {
                rest: {
                    depth: (symbol) => `https://www.okx.com/api/v5/market/books?instId=${symbol}&sz=400`
                },
                name: 'OKX',
                format: 'BTC-USDT',
                formatExample: 'BTC-USDT'
            },
            htx: {
                rest: {
                    depth: (symbol) => `https://api.huobi.pro/market/depth?symbol=${symbol.toLowerCase()}&type=step0&depth=100`
                },
                name: 'HTX',
                format: 'btcusdt',
                formatExample: 'btcusdt'
            }
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', init);
        
        function init() {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ—Ç–∫—É –º–æ–Ω–µ—Ç
            renderCoinsGrid();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            connectBtn.addEventListener('click', handleConnect);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±–∏—Ä–∂
            document.querySelectorAll('.exchange-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.exchange-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentExchange = e.target.dataset.exchange;
                    statusText.textContent = `–í—ã–±—Ä–∞–Ω–∞ –±–∏—Ä–∂–∞: ${exchangeAPIs[currentExchange].name}`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–Ω–µ—Ç—ã
                    updateAvailableCoins();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–∞ MEXC
                    if (currentExchange === 'mexc' && currentSymbol) {
                        mexcTradeBtn.style.display = 'inline-block';
                        updateMexcTradeLink();
                    } else {
                        mexcTradeBtn.style.display = 'none';
                    }
                });
            });
            
            // –í—ã–±–∏—Ä–∞–µ–º Binance –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.querySelector('[data-exchange="binance"]').click();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            timeframeSelect.addEventListener('change', () => {
                currentTimeframe = parseInt(timeframeSelect.value);
                if (isConnected) {
                    clearInterval(updateInterval);
                    updateInterval = setInterval(fetchOrderbookData, currentTimeframe);
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–Ω–µ—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –±–∏—Ä–∂–∏
        function updateAvailableCoins() {
            const coinItems = document.querySelectorAll('.coin-item');
            coinItems.forEach(item => {
                const symbol = item.dataset.symbol;
                const coin = popularCoins.find(c => c.symbol === symbol);
                if (coin && coin.available.includes(currentExchange)) {
                    item.style.opacity = '1';
                    item.style.cursor = 'pointer';
                } else {
                    item.style.opacity = '0.5';
                    item.style.cursor = 'not-allowed';
                }
            });
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏ –º–æ–Ω–µ—Ç
        function renderCoinsGrid() {
            coinsGrid.innerHTML = '';
            
            popularCoins.forEach(coin => {
                const coinElement = document.createElement('div');
                coinElement.className = 'coin-item';
                coinElement.classList.add(coin.change >= 0 ? 'rising' : 'falling');
                coinElement.dataset.symbol = coin.symbol;
                
                coinElement.innerHTML = `
                    <div class="coin-name">${coin.name}</div>
                    <div class="coin-price">$${coin.price.toFixed(coin.price < 0.01 ? 6 : 2)}</div>
                    <div class="coin-change ${coin.change >= 0 ? 'change-up' : 'change-down'}">
                        ${coin.change >= 0 ? '+' : ''}${coin.change.toFixed(1)}%
                    </div>
                `;
                
                coinElement.addEventListener('click', () => {
                    if (!coin.available.includes(currentExchange)) {
                        showError(`–ú–æ–Ω–µ—Ç–∞ ${coin.name} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ ${exchangeAPIs[currentExchange].name}`);
                        return;
                    }
                    
                    document.querySelectorAll('.coin-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    coinElement.classList.add('selected');
                    
                    currentSymbol = coin.symbol;
                    symbolInput.value = coin.symbol;
                    statusText.textContent = `–í—ã–±—Ä–∞–Ω–∞ –º–æ–Ω–µ—Ç–∞: ${coin.name}`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–∞ MEXC
                    if (currentExchange === 'mexc') {
                        mexcTradeBtn.style.display = 'inline-block';
                        updateMexcTradeLink();
                    }
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–æ–Ω–µ—Ç—ã
                    if (currentExchange) {
                        handleConnect();
                    }
                });
                
                coinsGrid.appendChild(coinElement);
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–∞ MEXC
        function updateMexcTradeLink() {
            if (currentSymbol && exchangeAPIs.mexc.tradeUrl) {
                const tradingSymbol = currentSymbol.replace('USDT', '_USDT');
                mexcTradeBtn.href = `https://www.mexc.com/ru-RU/exchange/${tradingSymbol}`;
                mexcTradeBtn.title = `–¢–æ—Ä–≥–æ–≤–∞—Ç—å ${currentSymbol} –Ω–∞ MEXC`;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function handleConnect() {
            if (!currentExchange) {
                showError('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∏—Ä–∂—É');
                return;
            }
            
            let newSymbol = symbolInput.value.trim().toUpperCase();
            
            if (!newSymbol) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é –ø–∞—Ä—É');
                return;
            }
            
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±–∏—Ä–∂
            newSymbol = normalizeSymbol(newSymbol, currentExchange);
            
            if (newSymbol !== currentSymbol) {
                currentSymbol = newSymbol;
                symbolInput.value = newSymbol;
            }
            
            currentTimeframe = parseInt(timeframeSelect.value);
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏ WebSocket
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞–∫–∞–Ω
            resetOrderbook();
            clearError();
            hideAlerts();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            setStatus('connecting', `–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${exchangeAPIs[currentExchange].name}...`);
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebSocket, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
            if (exchangeAPIs[currentExchange].ws && exchangeAPIs[currentExchange].ws.depth) {
                useWebSocket = true;
                setupWebSocket();
            } else {
                useWebSocket = false;
                wsStatus.textContent = "REST API";
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ REST API
                fetchOrderbookData();
                updateInterval = setInterval(fetchOrderbookData, currentTimeframe);
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function setupWebSocket() {
            try {
                let wsUrl;
                
                switch(currentExchange) {
                    case 'binance':
                        wsUrl = exchangeAPIs.binance.ws.depth(currentSymbol);
                        break;
                    case 'bybit':
                        wsUrl = exchangeAPIs.bybit.ws.depth;
                        break;
                    default:
                        useWebSocket = false;
                        wsStatus.textContent = "REST API";
                        fetchOrderbookData();
                        updateInterval = setInterval(fetchOrderbookData, currentTimeframe);
                        return;
                }
                
                ws = new WebSocket(wsUrl);
                wsStatus.textContent = "WebSocket";
                
                ws.onopen = () => {
                    setStatus('connected', `WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ ${exchangeAPIs[currentExchange].name}: ${currentSymbol}`);
                    
                    // –î–ª—è Bybit –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                    if (currentExchange === 'bybit') {
                        const subscribeMessage = {
                            op: "subscribe",
                            args: [`orderbook.100.${currentSymbol}`]
                        };
                        ws.send(JSON.stringify(subscribeMessage));
                    }
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    try {
                        let processedData;
                        
                        switch(currentExchange) {
                            case 'binance':
                                processedData = {
                                    bids: data.bids,
                                    asks: data.asks
                                };
                                break;
                            case 'bybit':
                                if (data.topic === `orderbook.100.${currentSymbol}`) {
                                    processedData = {
                                        bids: data.data.b,
                                        asks: data.data.a
                                    };
                                }
                                break;
                        }
                        
                        if (processedData) {
                            processOrderbookData(processedData);
                            isConnected = true;
                            retryCount = 0;
                        }
                    } catch (error) {
                        console.error('Error processing WS data:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    wsStatus.textContent = "–û—à–∏–±–∫–∞ WebSocket";
                    useWebSocket = false;
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ REST API
                    fetchOrderbookData();
                    updateInterval = setInterval(fetchOrderbookData, currentTimeframe);
                };
                
                ws.onclose = () => {
                    if (isConnected) {
                        wsStatus.textContent = "WebSocket –∑–∞–∫—Ä—ã—Ç";
                        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ REST API
                        fetchOrderbookData();
                        updateInterval = setInterval(fetchOrderbookData, currentTimeframe);
                    }
                };
                
            } catch (error) {
                console.error('WebSocket setup error:', error);
                useWebSocket = false;
                wsStatus.textContent = "REST API";
                fetchOrderbookData();
                updateInterval = setInterval(fetchOrderbookData, currentTimeframe);
            }
        }
        
        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±–∏—Ä–∂
        function normalizeSymbol(symbol, exchange) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
            let cleanSymbol = symbol.replace(/[\/_\-]/g, '');
            
            // –î–æ–±–∞–≤–ª—è–µ–º USDT –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (!cleanSymbol.endsWith('USDT')) {
                cleanSymbol += 'USDT';
            }
            
            // –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –±–∏—Ä–∂ –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            switch(exchange) {
                case 'kucoin':
                    return cleanSymbol.replace('USDT', '-USDT');
                case 'gateio':
                    return cleanSymbol.replace('USDT', '_USDT');
                case 'htx':
                    return cleanSymbol.toLowerCase();
                default:
                    return cleanSymbol;
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–∫–∞–Ω–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        async function fetchOrderbookData() {
            try {
                const apiUrl = exchangeAPIs[currentExchange].rest.depth(currentSymbol);
                const timestamp = new Date().getTime();
                const urlWithTimestamp = `${apiUrl}${apiUrl.includes('?') ? '&' : '?'}_=${timestamp}`;
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º timeout –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(urlWithTimestamp, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –±–∏—Ä–∂–∏
                let processedData;
                switch(currentExchange) {
                    case 'binance':
                        processedData = data;
                        break;
                    case 'bybit':
                        if (data.retCode !== 0) throw new Error(data.retMsg || `Code: ${data.retCode}`);
                        processedData = {
                            bids: data.result.b,
                            asks: data.result.a
                        };
                        break;
                    case 'mexc':
                        if (data.code) throw new Error(data.msg || `Code: ${data.code}`);
                        processedData = data;
                        break;
                    case 'kucoin':
                        if (data.code !== '200000') throw new Error(data.msg || `Code: ${data.code}`);
                        processedData = {
                            bids: data.data.bids,
                            asks: data.data.asks
                        };
                        break;
                    case 'gateio':
                        processedData = {
                            bids: data.bids,
                            asks: data.asks
                        };
                        break;
                    case 'okx':
                        if (data.code !== '0') throw new Error(data.msg || `Code: ${data.code}`);
                        processedData = {
                            bids: data.data[0].bids,
                            asks: data.data[0].asks
                        };
                        break;
                    case 'htx':
                        if (data.status === 'error') throw new Error(data.err-msg || 'Error response');
                        processedData = {
                            bids: data.tick.bids,
                            asks: data.tick.asks
                        };
                        break;
                    default:
                        processedData = data;
                }
                
                processOrderbookData(processedData);
                isConnected = true;
                setStatus('connected', `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ${exchangeAPIs[currentExchange].name}: ${currentSymbol}`);
                retryCount = 0;
                
            } catch (error) {
                console.error('Error fetching orderbook data:', error);
                isConnected = false;
                
                if (error.name === 'AbortError') {
                    showError('–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.', true);
                } else if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    setStatus('error', `–û—à–∏–±–∫–∞ (–ø–æ–ø—ã—Ç–∫–∞ ${retryCount}/${MAX_RETRIES})`);
                    setTimeout(() => fetchOrderbookData(), 2000);
                } else {
                    setStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                    showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ ${exchangeAPIs[currentExchange].name}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –±–∏—Ä–∂—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—ã.`, true);
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–∫–∞–Ω–∞
        function processOrderbookData(data) {
            if (!data || !data.bids || !data.asks) {
                throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            lastProcessedData = JSON.parse(JSON.stringify(orderbook));
            
            orderbook = {
                bids: {},
                asks: {}
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∫—É–ø–æ–∫ (bids)
            data.bids.forEach(bid => {
                const price = parseFloat(bid[0]);
                const quantity = parseFloat(bid[1]);
                if (!isNaN(price) && !isNaN(quantity)) {
                    orderbook.bids[price] = quantity;
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂ (asks)
            data.asks.forEach(ask => {
                const price = parseFloat(ask[0]);
                const quantity = parseFloat(ask[1]);
                if (!isNaN(price) && !isNaN(quantity)) {
                    orderbook.asks[price] = quantity;
                }
            });
            
            if (Object.keys(orderbook.bids).length === 0 || Object.keys(orderbook.asks).length === 0) {
                throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–≤–µ—Ä–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—ã.');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω
            updatePriceHistory();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
            identifySupportResistanceLevels();
            
            renderOrderbook();
            calculateStats();
            checkTrendAlerts();
            updateTradingAdvice();
            clearError();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
        function updatePriceHistory() {
            const bidPrices = Object.keys(orderbook.bids).map(Number);
            const askPrices = Object.keys(orderbook.asks).map(Number);
            
            if (bidPrices.length === 0 || askPrices.length === 0) return;
            
            const bestBid = Math.max(...bidPrices);
            const bestAsk = Math.min(...askPrices);
            const midPrice = (bestBid + bestAsk) / 2;
            
            const now = Date.now();
            priceHistory.push({ price: midPrice, time: now });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–Ω–∞—á–µ–Ω–∏–π
            if (priceHistory.length > 100) {
                priceHistory.shift();
            }
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∑–∞ 5 –º–∏–Ω—É—Ç
            const fiveMinutesAgo = now - 5 * 60 * 1000;
            const pastPrice = priceHistory.find(p => p.time >= fiveMinutesAgo);
            
            if (pastPrice) {
                const change = ((midPrice - pastPrice.price) / pastPrice.price) * 100;
                priceChange.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                priceChange.style.color = change >= 0 ? '#4caf50' : '#f44336';
            }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
        function identifySupportResistanceLevels() {
            supportLevels = [];
            resistanceLevels = [];
            
            const bidPrices = Object.keys(orderbook.bids).map(Number).sort((a, b) => b - a);
            const askPrices = Object.keys(orderbook.asks).map(Number).sort((a, b) => a - b);
            
            if (bidPrices.length < 10 || askPrices.length < 10) return;
            
            // –ò—â–µ–º –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –≤ —Å—Ç–∞–∫–∞–Ω–µ (–∫–ª–∞—Å—Ç–µ—Ä—ã)
            const significantLevels = [];
            const allLevels = [...bidPrices.slice(0, 20), ...askPrices.slice(0, 20)];
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –±–ª–∏–∑–∫–∏–µ —Ü–µ–Ω—ã
            const groupedLevels = {};
            allLevels.forEach(price => {
                const roundedPrice = parseFloat(price.toFixed(getPricePrecision()));
                if (!groupedLevels[roundedPrice]) {
                    groupedLevels[roundedPrice] = 0;
                }
                groupedLevels[roundedPrice] += orderbook.bids[price] || orderbook.asks[price] || 0;
            });
            
            // –ù–∞—Ö–æ–¥–∏–º —É—Ä–æ–≤–Ω–∏ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –æ–±—ä–µ–º–æ–º
            const sortedLevels = Object.entries(groupedLevels)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const midPrice = (bidPrices[0] + askPrices[0]) / 2;
            
            sortedLevels.forEach(([price, volume]) => {
                const priceNum = parseFloat(price);
                if (priceNum < midPrice) {
                    supportLevels.push(priceNum);
                } else {
                    resistanceLevels.push(priceNum);
                }
            });
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –≤–æ—Å—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–µ–Ω–¥–∞
        function checkTrendAlerts() {
            const bidValues = Object.values(orderbook.bids);
            const askValues = Object.values(orderbook.asks);
            
            if (bidValues.length === 0 || askValues.length === 0) return;
            
            const totalBid = bidValues.reduce((sum, vol) => sum + vol, 0);
            const totalAsk = askValues.reduce((sum, vol) => sum + vol, 0);
            const totalVolume = totalBid + totalAsk;
            
            if (totalVolume === 0) return;
            
            const bidRatio = (totalBid / totalVolume) * 100;
            const askRatio = (totalAsk / totalVolume) * 100;
            const imbalance = ((totalBid - totalAsk) / totalVolume) * 100;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑
            updateClusterAnalysis(bidRatio);
            
            // –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –≤–æ—Å—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–µ–Ω–¥–∞
            const isUptrend = totalBid > totalAsk * 1.5 && // –ü–æ–∫—É–ø–æ–∫ –Ω–∞ 50% –±–æ–ª—å—à–µ
                             imbalance > 20 && // –î–∏—Å–±–∞–ª–∞–Ω—Å –±–æ–ª–µ–µ 20%
                             bidRatio > 60; // –î–æ–ª—è –ø–æ–∫—É–ø–æ–∫ –±–æ–ª–µ–µ 60%
            
            // –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –Ω–∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–µ–Ω–¥–∞
            const isDowntrend = totalAsk > totalBid * 1.5 &&
                               imbalance < -20 &&
                               askRatio > 60;
            
            // –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            const isWarning = Math.abs(imbalance) > 30;
            
            if (isUptrend) {
                showAlert(trendAlert, `–°–∏–ª—å–Ω—ã–π –≤–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥! –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: ${Math.round(bidRatio)}% –ø–æ–∫—É–ø–æ–∫`);
                trendStrength.textContent = Math.round(imbalance);
                trendAdvice.textContent = "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∫—É–ø–∫—É. –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –Ω–∞ –ø–æ–∫—É–ø–∫—É —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–æ—Å—Ç —Ü–µ–Ω—ã. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—Ç–æ–ø-–ª–æ—Å—Å –Ω–∏–∂–µ –±–ª–∏–∂–∞–π—à–µ–≥–æ —É—Ä–æ–≤–Ω—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏.";
                
                // –í–∫–ª—é—á–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                bidAlert.classList.add('active');
                imbalanceAlert.classList.add('active');
                ratioAlert.classList.add('active');
                
                hideAlert(warningAlert);
                hideAlert(dangerAlert);
            } else if (isDowntrend) {
                showAlert(dangerAlert, `–°–∏–ª—å–Ω—ã–π –Ω–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥! –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: ${Math.round(askRatio)}% –ø—Ä–æ–¥–∞–∂`);
                dangerAdvice.textContent = "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–¥–∞–∂—É –∏–ª–∏ –æ–∂–∏–¥–∞–Ω–∏–µ. –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –Ω–∞ –ø—Ä–æ–¥–∞–∂—É —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ —Ü–µ–Ω—ã. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –ø–æ–∫—É–ø–∫–∞–º–∏.";
                
                hideAlert(trendAlert);
                hideAlert(warningAlert);
            } else if (isWarning) {
                showAlert(warningAlert, `–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å: ${Math.round(imbalance)}%`);
                warningAdvice.textContent = imbalance > 0 ? 
                    "–ù–∞–±–ª—é–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–≤–µ—Å –ø–æ–∫—É–ø–æ–∫. –í–æ–∑–º–æ–∂–µ–Ω –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π —Ä–æ—Å—Ç, –Ω–æ –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–æ–≤—É—à–∫–∞ –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–º." :
                    "–ù–∞–±–ª—é–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–≤–µ—Å –ø—Ä–æ–¥–∞–∂. –í–æ–∑–º–æ–∂–µ–Ω –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π –æ—Ç–∫–∞—Ç, –Ω–æ –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Ä–æ—Å—Ç–æ–º.";
                
                hideAlert(trendAlert);
                hideAlert(dangerAlert);
            } else {
                hideAlerts();
                bidAlert.classList.remove('active');
                imbalanceAlert.classList.remove('active');
                ratioAlert.classList.remove('active');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        function updateClusterAnalysis(bidRatio) {
            const position = Math.min(100, Math.max(0, bidRatio));
            clusterMarker.style.left = `${position}%`;
            
            if (bidRatio > 60) {
                clusterText.textContent = "–°–∏–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—å—Å–∫–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å";
                clusterText.style.color = '#4caf50';
            } else if (bidRatio < 40) {
                clusterText.textContent = "–°–∏–ª—å–Ω–∞—è –ø—Ä–æ–¥–∞–∂–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å";
                clusterText.style.color = '#f44336';
            } else {
                clusterText.textContent = "–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å";
                clusterText.style.color = '#8c98a8';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        function updateTradingAdvice() {
            const bidValues = Object.values(orderbook.bids);
            const askValues = Object.values(orderbook.asks);
            
            if (bidValues.length === 0 || askValues.length === 0) return;
            
            const totalBid = bidValues.reduce((sum, vol) => sum + vol, 0);
            const totalAsk = askValues.reduce((sum, vol) => sum + vol, 0);
            const imbalance = ((totalBid - totalAsk) / (totalBid + totalAsk)) * 100;
            
            const bidPrices = Object.keys(orderbook.bids).map(Number).sort((a, b) => b - a);
            const askPrices = Object.keys(orderbook.asks).map(Number).sort((a, b) => a - b);
            
            if (bidPrices.length === 0 || askPrices.length === 0) return;
            
            const bestBid = bidPrices[0];
            const bestAsk = askPrices[0];
            const spread = bestAsk - bestBid;
            const spreadPercent = (spread / bestBid) * 100;
            
            let advice = "";
            
            // –ê–Ω–∞–ª–∏–∑ —Å–ø—Ä–µ–¥–∞
            if (spreadPercent > 0.1) {
                advice += `üìä –í—ã—Å–æ–∫–∏–π —Å–ø—Ä–µ–¥ (${spreadPercent.toFixed(2)}%) - –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å —Ä—ã–Ω–æ—á–Ω—ã–º–∏ –æ—Ä–¥–µ—Ä–∞–º–∏.\n`;
            } else {
                advice += `üìä –ù–∏–∑–∫–∏–π —Å–ø—Ä–µ–¥ (${spreadPercent.toFixed(2)}%) - —Ö–æ—Ä–æ—à–∏–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏.\n`;
            }
            
            // –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–æ–≤
            if (imbalance > 20) {
                advice += `üìà –°–∏–ª—å–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ (–¥–∏—Å–±–∞–ª–∞–Ω—Å: ${imbalance.toFixed(1)}%). –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–∫—É–ø–∫—É.\n`;
            } else if (imbalance < -20) {
                advice += `üìâ –°–∏–ª—å–Ω—ã–µ –ø—Ä–æ–¥–∞–≤—Ü—ã (–¥–∏—Å–±–∞–ª–∞–Ω—Å: ${Math.abs(imbalance).toFixed(1)}%). –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–æ–¥–∞–∂—É.\n`;
            } else {
                advice += `‚öñÔ∏è –ë–∞–ª–∞–Ω—Å —Å–∏–ª (–¥–∏—Å–±–∞–ª–∞–Ω—Å: ${imbalance.toFixed(1)}%). –û–∂–∏–¥–∞–π—Ç–µ —Å–∏–≥–Ω–∞–ª–∞.\n`;
            }
            
            // –ê–Ω–∞–ª–∏–∑ —É—Ä–æ–≤–Ω–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
            if (supportLevels.length > 0) {
                advice += `üõ°Ô∏è –ë–ª–∏–∂–∞–π—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞: ${supportLevels[0].toFixed(getPricePrecision())}\n`;
            }
            
            if (resistanceLevels.length > 0) {
                advice += `üöß –ë–ª–∏–∂–∞–π—à–µ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: ${resistanceLevels[0].toFixed(getPricePrecision())}\n`;
            }
            
            // –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            advice += `\nüí° –°–æ–≤–µ—Ç—ã:\n`;
            advice += `- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –≤–º–µ—Å—Ç–æ —Ä—ã–Ω–æ—á–Ω—ã—Ö\n`;
            advice += `- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —Å—Ç–æ–ø-–ª–æ—Å—Å –Ω–∞ 2-3% –æ—Ç –≤—Ö–æ–¥–∞\n`;
            advice += `- –§–∏–∫—Å–∏—Ä—É–π—Ç–µ –ø—Ä–∏–±—ã–ª—å —á–∞—Å—Ç—è–º–∏: 50% –Ω–∞ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–∏, 50% –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å\n`;
            
            tradingAdvice.textContent = advice;
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–∞–∫–∞–Ω–∞
        function renderOrderbook() {
            const bidPrices = Object.keys(orderbook.bids).map(Number).sort((a, b) => b - a);
            const askPrices = Object.keys(orderbook.asks).map(Number).sort((a, b) => a - b);
            
            if (bidPrices.length === 0 || askPrices.length === 0) {
                bidsContainer.innerHTML = '<div class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∫—É–ø–æ–∫</div>';
                asksContainer.innerHTML = '<div class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–¥–∞–∂</div>';
                return;
            }
            
            const bidValues = Object.values(orderbook.bids);
            const askValues = Object.values(orderbook.asks);
            const maxBid = Math.max(...bidValues);
            const maxAsk = Math.max(...askValues);
            const maxVolume = Math.max(maxBid, maxAsk);
            
            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ–∫—É–ø–∫–∏
            bidsContainer.innerHTML = '';
            bidPrices.slice(0, 20).forEach(price => {
                const quantity = orderbook.bids[price];
                const width = Math.max(5, (quantity / maxVolume) * 100);
                
                const isSupport = supportLevels.some(level => Math.abs(level - price) < price * 0.001);
                
                const row = document.createElement('div');
                row.className = 'order-row bid';
                if (isSupport) {
                    row.classList.add('support-level');
                }
                
                row.innerHTML = `
                    ${isSupport ? '<div class="level-label">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>' : ''}
                    <span class="price">${price.toFixed(getPricePrecision(price))}</span>
                    <span class="size">${quantity.toFixed(6)}</span>
                    <div class="size-bar" style="width: ${width}%"></div>
                `;
                bidsContainer.appendChild(row);
            });
            
            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–æ–¥–∞–∂–∏
            asksContainer.innerHTML = '';
            askPrices.slice(0, 20).forEach(price => {
                const quantity = orderbook.asks[price];
                const width = Math.max(5, (quantity / maxVolume) * 100);
                
                const isResistance = resistanceLevels.some(level => Math.abs(level - price) < price * 0.001);
                
                const row = document.createElement('div');
                row.className = 'order-row ask';
                if (isResistance) {
                    row.classList.add('resistance-level');
                }
                
                row.innerHTML = `
                    ${isResistance ? '<div class="level-label">–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</div>' : ''}
                    <span class="price">${price.toFixed(getPricePrecision(price))}</span>
                    <span class="size">${quantity.toFixed(6)}</span>
                    <div class="size-bar" style="width: ${width}%"></div>
                `;
                asksContainer.appendChild(row);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø—Ä–µ–¥
            const bestBid = bidPrices[0];
            const bestAsk = askPrices[0];
            const spreadValue = bestAsk - bestBid;
            const spreadPercent = (spreadValue / bestBid) * 100;
            
            spreadElement.textContent = `–°–ø—Ä–µ–¥: ${spreadValue.toFixed(getPricePrecision(spreadValue))} (${spreadPercent.toFixed(2)}%) | –ü–æ–∫—É–ø–∫–∞: ${bestBid.toFixed(getPricePrecision(bestBid))} | –ü—Ä–æ–¥–∞–∂–∞: ${bestAsk.toFixed(getPricePrecision(bestAsk))}`;
            lastPrice.textContent = ((bestBid + bestAsk) / 2).toFixed(getPricePrecision((bestBid + bestAsk) / 2));
            
            updateDepthChart(bidPrices, askPrices, maxVolume);
        }
        
        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function calculateStats() {
            const bidValues = Object.values(orderbook.bids);
            const askValues = Object.values(orderbook.asks);
            
            const totalBid = bidValues.reduce((sum, vol) => sum + vol, 0);
            const totalAsk = askValues.reduce((sum, vol) => sum + vol, 0);
            const totalVolume = totalBid + totalAsk;
            
            totalBidVolume.textContent = totalBid.toFixed(2);
            totalAskVolume.textContent = totalAsk.toFixed(2);
            
            const imbalance = totalVolume > 0 ? ((totalBid - totalAsk) / totalVolume) * 100 : 0;
            orderbookImbalance.textContent = `${imbalance.toFixed(2)}%`;
            orderbookImbalance.style.color = imbalance >= 0 ? '#4caf50' : '#f44336';
            
            const maxBid = bidValues.length > 0 ? Math.max(...bidValues) : 0;
            const maxAsk = askValues.length > 0 ? Math.max(...askValues) : 0;
            
            maxBidDensity.textContent = maxBid.toFixed(6);
            maxAskDensity.textContent = maxAsk.toFixed(6);
            
            const ratio = totalAsk > 0 ? (totalBid / totalAsk).toFixed(2) : '‚àû';
            volumeRatio.textContent = `${ratio}:1`;
            volumeRatio.style.color = totalBid > totalAsk ? '#4caf50' : '#f44336';
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function setStatus(status, message) {
            statusText.textContent = message;
            statusIndicator.className = 'status-indicator';
            statusIndicator.classList.add(`status-${status}`);
        }
        
        function showError(message, showRetry = false) {
            errorContainer.innerHTML = `
                <div class="error-message">
                    <strong>–û—à–∏–±–∫–∞:</strong> ${message}
                    ${showRetry ? '<button class="retry-button" onclick="handleConnect()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>' : ''}
                </div>
            `;
        }
        
        function showAlert(alertElement, message) {
            alertElement.querySelector('strong').textContent = message;
            alertElement.classList.add('visible');
            
            if (alertTimeout) clearTimeout(alertTimeout);
            alertTimeout = setTimeout(() => hideAlert(alertElement), 10000);
        }
        
        function hideAlert(alertElement) {
            if (alertElement) {
                alertElement.classList.remove('visible');
            }
        }
        
        function hideAlerts() {
            hideAlert(trendAlert);
            hideAlert(warningAlert);
            hideAlert(dangerAlert);
        }
        
        function clearError() {
            errorContainer.innerHTML = '';
        }
        
        function resetOrderbook() {
            orderbook = { bids: {}, asks: {} };
            bidsContainer.innerHTML = asksContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';
            spreadElement.textContent = '–°–ø—Ä–µ–¥: –ó–∞–≥—Ä—É–∑–∫–∞...';
            totalBidVolume.textContent = totalAskVolume.textContent = '0';
            orderbookImbalance.textContent = '0%';
            maxBidDensity.textContent = maxAskDensity.textContent = '0';
            volumeRatio.textContent = '1:1';
            priceChange.textContent = '0%';
            bidDepth.style.width = askDepth.style.width = '0%';
            lastPrice.textContent = '0';
            tradingAdvice.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
            clusterMarker.style.left = '50%';
            clusterText.textContent = '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å';
            clusterText.style.color = '#8c98a8';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω—ã
        function getPricePrecision(price = 0) {
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 0.0001, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 8 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            if (price < 0.0001) return 8;
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 0.01, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 6 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            if (price < 0.01) return 6;
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 1, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 4 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            if (price < 1) return 4;
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 100, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 3 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            if (price < 100) return 3;
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 1000, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            if (price < 1000) return 2;
            // –î–ª—è –±–æ–ª—å—à–∏—Ö —Ü–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            return 2;
        }
        
        function updateDepthChart(bidPrices, askPrices, maxVolume) {
            bidDepth.style.width = askDepth.style.width = '0%';
            if (bidPrices.length === 0 || askPrices.length === 0) return;
            
            let cumulativeBid = 0, cumulativeAsk = 0;
            for (let i = 0; i < Math.min(bidPrices.length, 50); i++) {
                cumulativeBid += orderbook.bids[bidPrices[i]];
            }
            for (let i = 0; i < Math.min(askPrices.length, 50); i++) {
                cumulativeAsk += orderbook.asks[askPrices[i]];
            }
            
            const maxCumulative = Math.max(cumulativeBid, cumulativeAsk);
            if (maxCumulative > 0) {
                bidDepth.style.width = `${(cumulativeBid / maxCumulative) * 50}%`;
                askDepth.style.width = `${(cumulativeAsk / maxCumulative) * 50}%`;
            }
        }
    </script>
</body>
</html>
